<<!DOCTYPE html>
<html lang="be">
<head>
    <meta charset="utf-8" />
    <title>Каменны век на тэрыторыі Беларусі</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Падключэнне стыляў Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { margin: 0; padding: 0; font-family: 'Helvetica Neue', Arial, sans-serif; }
        #map { height: 100vh; width: 100%; }
        
        /* Панэль кіравання */
        #controls {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            text-align: center;
            width: 85%;
            max-width: 700px;
        }
        
        #yearDisplay {
            font-size: 28px;
            font-weight: bold;
            color: #2c3e50;
            display: block;
            margin-bottom: 15px;
            min-width: 200px;
        }
        
        input[type=range] {
            width: 100%;
            cursor: pointer;
            margin: 10px 0;
        }

        .legend-hint {
            font-size: 14px;
            color: #7f8c8d;
            margin-top: 5px;
        }

        /* --- СТЫЛІ ДЛЯ ПОДПІСАЎ --- */
        .glacier-label {
            background: transparent;
            border: none;
            box-shadow: none;
            color: #006994;
            font-size: 14px;
            font-weight: bold;
            text-transform: uppercase;
            text-shadow: 1px 1px 2px white;
        }

        .culture-label {
            font-size: 12px;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #999;
            padding: 2px 5px;
            border-radius: 3px;
        }
    </style>
</head>
<body>

    <div id="controls">
        <span id="yearDisplay">Загрузка дадзеных...</span>
        <input type="range" id="yearSlider" min="0" max="100" value="0">
        <div class="legend-hint">Рухайце паўзунок, каб назіраць за гісторыяй (крок 1000 год)</div>
    </div>

    <div id="map"></div>

    <!-- Падключэнне скрыптоў Leaflet -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // 1. Ініцыялізацыя мапы
        var map = L.map('map').setView([53.7, 28.0], 6);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap &copy; CARTO',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);

        // 2. Шкала часу
        var timeline = [];
        for (let y = -30000; y <= 0; y += 1000) { 
            timeline.push(y); 
        }

        var slider = document.getElementById('yearSlider');
        var display = document.getElementById('yearDisplay');
        
        slider.max = timeline.length - 1;
        slider.value = 0;

        function formatYear(y) {
            return y < 0 ? Math.abs(y) + " да н.э." : y + " н.э.";
        }

        var allData = null;      
        var currentLayer = null; 

        // 3. Загрузка дадзеных
        fetch('data/all_cultures.geojson')
            .then(response => response.json())
            .then(data => {
                allData = data; 
                updateMap();    
            })
            .catch(error => {
                console.error("Памылка загрузкі:", error);
                display.innerText = "Памылка загрузкі файла data/all_cultures.geojson";
            });

        // --- НОВАЯ ФУНКЦЫЯ: Падлік плошчы для сартыроўкі ---
        function getFeatureArea(feature) {
            if (!feature.geometry) return 0;
            var layer = L.geoJSON(feature);
            var bounds = layer.getBounds();
            var width = bounds.getEast() - bounds.getWest();
            var height = bounds.getNorth() - bounds.getSouth();
            return width * height;
        }

        // 4. Функцыя абнаўлення мапы (ВЫПРАЎЛЕНАЯ)
        function updateMap() {
            if (!allData) return; 

            var index = parseInt(slider.value);
            var currentYear = timeline[index];
            display.innerText = formatYear(currentYear);

            if (currentLayer) {
                map.removeLayer(currentLayer);
            }

            // КРОК А: Фільтруем спіс уручную
            var visibleFeatures = allData.features.filter(function(feature) {
                return (currentYear >= feature.properties.startYear && 
                        currentYear <= feature.properties.endYear);
            });

            // КРОК Б: Сартуем (Вялікія -> Маленькія)
            // Гэта гарантуе, што маленькія культуры лягуць ПАВЕРХ вялікіх
            visibleFeatures.sort(function(a, b) {
                return getFeatureArea(b) - getFeatureArea(a);
            });

            // КРОК В: Ствараем пласт ужо з адсартаванымі дадзенымі
            currentLayer = L.geoJSON({type: "FeatureCollection", features: visibleFeatures}, {
                
                style: function(feature) {
                    return {
                        fillColor: feature.properties.color || '#3388ff',
                        weight: 1,
                        opacity: 1,
                        color: 'white',
                        fillOpacity: 0.6
                    };
                },

                onEachFeature: function(feature, layer) {
                    // Логіка подпісаў
                    if (feature.properties.type === 'glacier') {
                        layer.bindTooltip(feature.properties.name, {
                            permanent: true,
                            direction: "center",
                            className: "glacier-label"
                        });
                    } else {
                        layer.bindTooltip(feature.properties.name, {
                            permanent: false,
                            direction: "center",
                            className: "culture-label"
                        });
                    }

                    // Логіка падсвятлення
                    layer.on({
                        mouseover: function(e) {
                            var l = e.target;
                            l.setStyle({
                                weight: 3,
                                color: '#666',
                                fillOpacity: 0.9
                            });
                            if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                                l.bringToFront();
                            }
                        },
                        mouseout: function(e) {
                            currentLayer.resetStyle(e.target);
                        }
                    });
                }
            }).addTo(map);
        }

        slider.addEventListener('input', updateMap);

    </script>
</body>
</html>
