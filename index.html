<!DOCTYPE html>
<html lang="be">
<head>
    <meta charset="utf-8" />
    <title>–Ü–Ω—Ç—ç—Ä–∞–∫—Ç—ã—û–Ω–∞—è –º–∞–ø–∞ –ë–µ–ª–∞—Ä—É—Å—ñ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { margin: 0; padding: 0; font-family: 'Helvetica Neue', Arial, sans-serif; }
        #map { height: 100vh; width: 100%; }
        
        /* –ü–∞–Ω—ç–ª—å –∫—ñ—Ä–∞–≤–∞–Ω–Ω—è */
        #controls {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            text-align: center;
            width: 90%;
            max-width: 650px;
        }
        
        #yearDisplay {
            font-size: 26px;
            font-weight: 800;
            color: #2c3e50;
            display: block;
            margin-bottom: 10px;
        }
        
        input[type=range] {
            width: 100%;
            cursor: pointer;
            margin: 10px 0;
            accent-color: #2c3e50;
        }

        .legend-hint {
            font-size: 14px;
            color: #555;
            margin-top: 8px;
            font-weight: 500;
        }

        /* --- –õ–ï–ì–ï–ù–î–ê --- */
        .legend-box {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 10px;
            font-size: 12px;
            color: #666;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }

        /* --- –ö–£–†–°–û–† –Ü –°–¢–´–õ–Ü --- */
        .interactive-culture {
            cursor: pointer !important; 
        }
        .static-glacier {
            cursor: default !important;
        }

        /* –ü–æ–¥–ø—ñ—Å—ã */
        .glacier-label {
            background: transparent;
            border: none;
            box-shadow: none;
            color: #006994;
            font-size: 14px;
            font-weight: bold;
            text-transform: uppercase;
            text-shadow: 1px 1px 2px white;
        }

        .culture-label {
            font-size: 13px;
            font-weight: bold;
            color: #333;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #aaa;
            padding: 4px 8px;
            border-radius: 4px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>

    <div id="controls">
        <span id="yearDisplay">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
        <input type="range" id="yearSlider" min="0" max="100" value="0">
        
        <div class="legend-hint">
            –†—É—Ö–∞–π—Ü–µ –ø–∞—û–∑—É–Ω–æ–∫ —á–∞—Å—É. <br>
            üëá <b>–ù–∞–≤—è–¥–∑—ñ—Ü–µ –∫—É—Ä—Å–æ—Ä –Ω–∞ –∫–∞–ª—è—Ä–æ–≤—ã—è –≤–æ–±–ª–∞—Å—Ü—ñ</b>, –∫–∞–± –¥–∞–≤–µ–¥–∞—Ü—Ü–∞ –Ω–∞–∑–≤—É –∫—É–ª—å—Ç—É—Ä—ã.
        </div>

        <div class="legend-box">
            <div class="legend-item">
                <span class="dot" style="background: #90E0EF;"></span> –õ–µ–¥–∞–≤—ñ–∫
            </div>
            <div class="legend-item">
                <span class="dot" style="background: #D4A373;"></span> –ê—Ä—Ö–µ–∞–ª–∞–≥—ñ—á–Ω—ã—è –∫—É–ª—å—Ç—É—Ä—ã
            </div>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        var map = L.map('map').setView([53.7, 28.0], 6);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap &copy; CARTO',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);

      var timeline = [];

        // 1. –°—Ç–∞—Ä–∞–∂—ã—Ç–Ω—ã –ø–µ—Ä—ã—è–¥ (–õ–µ–¥–∞–≤—ñ–∫): –∞–¥ -30000 –¥–∞ -5000 (–∫—Ä–æ–∫ 1000 –≥–∞–¥–æ—û)
        for (let y = -30000; y < -5000; y += 1000) { 
            timeline.push(y); 
        }

        // 2. –î–∞ –Ω–∞—à–∞–π —ç—Ä—ã (–ù–µ–∞–ª—ñ—Ç, –ë—Ä–æ–Ω–∑–∞, –ñ–∞–ª–µ–∑–∞): –∞–¥ -5000 –¥–∞ 0 (–∫—Ä–æ–∫ 100 –≥–∞–¥–æ—û)
        // –ó–≤—è—Ä–Ω—ñ—Ü–µ —û–≤–∞–≥—É: —Ç—É—Ç –º—ã —ñ–¥–∑–µ–º —Å—Ç—Ä–æ–≥–∞ –¥–∞ < 0, –∫–∞–± –Ω–µ –¥—É–±–ª—è–≤–∞—Ü—å –Ω—É–ª—å
        for (let y = -5000; y < 0; y += 100) { 
            timeline.push(y); 
        }

        // 3. –ù–∞—à–∞ —ç—Ä–∞ (–°—è—Ä—ç–¥–Ω—è–≤–µ—á—á–∞): –∞–¥ 0 –¥–∞ 1200 (–∫—Ä–æ–∫ 50 –≥–∞–¥–æ—û)
        // –†–æ–±—ñ–º –∫—Ä–æ–∫ –¥—Ä–∞–±–Ω–µ–π—à—ã–º (50 –≥–∞–¥–æ—û), –±–æ –ø–∞–¥–∑–µ—ñ —Ä–∞–∑–≤—ñ–≤–∞—é—Ü—Ü–∞ —Ö—É—Ç—á—ç–π
        for (let y = 0; y <= 1200; y += 50) {
            timeline.push(y);
        }

        var slider = document.getElementById('yearSlider');
        var display = document.getElementById('yearDisplay');
        
        slider.max = timeline.length - 1;
        slider.value = 0;

        function formatYear(y) {
            return y < 0 ? Math.abs(y) + " –¥–∞ –Ω.—ç." : y + " –Ω.—ç.";
        }

        var allData = null;      
        var currentLayer = null; 

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∑ –∞–Ω—Ç—ã-–∫—ç—à–∞–º
        fetch('data/all_cultures.geojson?v=' + Math.random())
            .then(response => response.json())
            .then(data => {
                allData = data; 
                updateMap();    
            })
            .catch(error => { console.error(error); });

        function getFeatureArea(feature) {
            if (!feature.geometry) return 0;
            var layer = L.geoJSON(feature);
            var bounds = layer.getBounds();
            return (bounds.getEast() - bounds.getWest()) * (bounds.getNorth() - bounds.getSouth());
        }

        function updateMap() {
            if (!allData) return; 

            var index = parseInt(slider.value);
            var currentYear = timeline[index];
            display.innerText = formatYear(currentYear);

            if (currentLayer) map.removeLayer(currentLayer);

            var visibleFeatures = allData.features.filter(function(feature) {
                return (currentYear >= feature.properties.startYear && 
                        currentYear <= feature.properties.endYear);
            });

            // –°–∞—Ä—Ç—ã—Ä–æ—û–∫–∞: –í—è–ª—ñ–∫—ñ—è —û–Ω—ñ–∑, –º–∞–ª–µ–Ω—å–∫—ñ—è –Ω–∞–≤–µ—Ä—Ö
            visibleFeatures.sort(function(a, b) {
                return getFeatureArea(b) - getFeatureArea(a);
            });

            currentLayer = L.geoJSON({type: "FeatureCollection", features: visibleFeatures}, {
                
                style: function(feature) {
                    return {
                        fillColor: feature.properties.color || '#3388ff',
                        weight: 1,
                        opacity: 1,
                        color: 'white',
                        fillOpacity: 0.65,
                        className: feature.properties.type === 'culture' ? 'interactive-culture' : 'static-glacier'
                    };
                },

                onEachFeature: function(feature, layer) {
                    // –ü–æ–¥–ø—ñ—Å—ã
                    if (feature.properties.type === 'glacier') {
                        layer.bindTooltip(feature.properties.name, {
                            permanent: true,
                            direction: "center",
                            className: "glacier-label"
                        });
                    } else {
                        layer.bindTooltip(feature.properties.name, {
                            permanent: false,
                            direction: "center",
                            className: "culture-label"
                        });
                    }

                    // Hover —ç—Ñ–µ–∫—Ç—ã
                    layer.on({
                        mouseover: function(e) {
                            var l = e.target;
                            if (feature.properties.type === 'culture') {
                                l.setStyle({
                                    weight: 2,
                                    color: '#333',     // –¶—ë–º–Ω–∞—è –º—è–∂–∞
                                    fillOpacity: 0.9,  // –Ø—Ä–∫–∞—è –∑–∞–ª—ñ—û–∫–∞
                                    dashArray: ''
                                });
                                // –ú–´ –í–´–î–ê–õ–Ü–õ–Ü bringToFront(), –∫–∞–± –≤—è–ª—ñ–∫—ñ—è –ø–ª–∞—Å—Ç—ã –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–ª—ñ –º–∞–ª–µ–Ω—å–∫—ñ—è
                            }
                        },
                        mouseout: function(e) {
                            currentLayer.resetStyle(e.target);
                        }
                    });
                }
            }).addTo(map);
        }

        slider.addEventListener('input', updateMap);
    </script>
</body>
</html>
